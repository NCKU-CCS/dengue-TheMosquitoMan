var Quintus=function t(e){var i=function(t,e,n){return i.select(t,e,n)};i.select=function(){},i.include=function(e){return i._each(i._normalizeArg(e),function(e){var n=t[e]||e;if(!i._isFunction(n))throw"Invalid Module:"+e;n(i)}),i},i._normalizeArg=function(t){return i._isString(t)&&(t=t.replace(/\s+/g,"").split(",")),i._isArray(t)||(t=[t]),t},i._extend=function(t,e){if(!e)return t;for(var i in e)t[i]=e[i];return t},i._clone=function(t){return i._extend({},t)},i._defaults=function(t,e){if(!e)return t;for(var i in e)void 0===t[i]&&(t[i]=e[i]);return t},i._has=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i._isString=function(t){return"string"==typeof t},i._isNumber=function(t){return"[object Number]"===Object.prototype.toString.call(t)},i._isFunction=function(t){return"[object Function]"===Object.prototype.toString.call(t)},i._isObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},i._isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},i._isUndefined=function(t){return void 0===t},i._popProperty=function(t,e){var i=t[e];return delete t[e],i},i._each=function(t,e,i){if(null!=t)if(t.forEach)t.forEach(e,i);else if(t.length===+t.length)for(var n=0,s=t.length;s>n;n++)e.call(i,t[n],n,t);else for(var o in t)e.call(i,t[o],o,t)},i._invoke=function(t,e,i,n){if(null!=t)for(var s=0,o=t.length;o>s;s++)t[s][e](i,n)},i._detect=function(t,e,i,n,s){var o;if(null!=t){if(t.length===+t.length){for(var r=0,a=t.length;a>r;r++)if(o=e.call(i,t[r],r,n,s))return o;return!1}for(var h in t)if(o=e.call(i,t[h],h,n,s))return o;return!1}},i._map=function(t,e,n){var s=[];return null==t?s:t.map?t.map(e,n):(i._each(t,function(t,i,o){s[s.length]=e.call(n,t,i,o)}),t.length===+t.length&&(s.length=t.length),s)},i._uniq=function(t){t=t.slice().sort();for(var e=[],i=null,n=0;n<t.length;n++)void 0!==t[n]&&i!==t[n]&&e.push(t[n]),i=t[n];return e},i._shuffle=function(t){var e,n=[];return i._each(t,function(t,i){e=Math.floor(Math.random()*(i+1)),n[i]=n[e],n[e]=t}),n},i._keys=Object.keys||function(t){if(i._isObject(t))throw new TypeError("Invalid object");var e=[];for(var n in t)i._has(t,n)&&(e[e.length]=n);return e},i._range=function(t,e,i){i=i||1;for(var n=Math.max(Math.ceil((e-t)/i),0),s=0,o=new Array(n);n>s;)o[s++]=t,t+=i;return o};var n=0;return i._uniqueId=function(){return n++},i.options={imagePath:"images/",audioPath:"audio/",dataPath:"data/",audioSupported:["mp3","ogg"],sound:!0,frameTimeLimit:100,autoFocus:!0},e&&i._extend(i.options,e),i.gameLoop=function(t){return i.lastGameLoopFrame=(new Date).getTime(),i.loop=!0,i._loopFrame=0,i.gameLoopCallbackWrapper=function(){var e=(new Date).getTime();i._loopFrame++,i.loop=window.requestAnimationFrame(i.gameLoopCallbackWrapper);var n=e-i.lastGameLoopFrame;n>i.options.frameTimeLimit&&(n=i.options.frameTimeLimit),t.apply(i,[n/1e3]),i.lastGameLoopFrame=e},window.requestAnimationFrame(i.gameLoopCallbackWrapper),i},i.pauseGame=function(){i.loop&&window.cancelAnimationFrame(i.loop),i.loop=null},i.unpauseGame=function(){i.loop||(i.lastGameLoopFrame=(new Date).getTime(),i.loop=window.requestAnimationFrame(i.gameLoopCallbackWrapper))},function(){var t=!1,e=/xyz/.test(function(){})?/\b_super\b/:/.*/;i.Class=function(){},i.Class.prototype.isA=function(t){return this.className===t},i.Class.extend=function(n,s,o){function r(t,e){return function(){var i=this._super;this._super=h[t];var n=e.apply(this,arguments);return this._super=i,n}}function a(){!t&&this.init&&this.init.apply(this,arguments)}i._isString(n)||(o=s,s=n,n=null);var h=this.prototype,l=this;t=!0;var c=new l;t=!1;for(var u in s)c[u]="function"==typeof s[u]&&"function"==typeof h[u]&&e.test(s[u])?r(u,s[u]):s[u];return a.prototype=c,a.prototype.constructor=a,a.extend=i.Class.extend,o&&i._extend(a,o),n&&(i[n]=a,a.prototype.className=n,a.className=n),a}}(),i.Class.extend("Evented",{on:function(t,e,n){if(i._isArray(t)||-1!==t.indexOf(",")){t=i._normalizeArg(t);for(var s=0;s<t.length;s++)this.on(t[s],e,n)}else n||(n=e,e=null),n||(n=t),i._isString(n)&&(n=(e||this)[n]),this.listeners=this.listeners||{},this.listeners[t]=this.listeners[t]||[],this.listeners[t].push([e||this,n]),e&&(e.binds||(e.binds=[]),e.binds.push([this,t,n]))},trigger:function(t,e){if(this.listeners&&this.listeners[t])for(var i=0,n=this.listeners[t].length;n>i;i++){var s=this.listeners[t][i];s[1].call(s[0],e)}},off:function(t,e,n){if(e){i._isString(n)&&e[n]&&(n=e[n]);var s=this.listeners&&this.listeners[t];if(s)for(var o=s.length-1;o>=0;o--)s[o][0]===e&&(n&&n!==s[o][1]||this.listeners[t].splice(o,1))}else this.listeners[t]&&delete this.listeners[t]},debind:function(){if(this.binds)for(var t=0,e=this.binds.length;e>t;t++){var i=this.binds[t],n=i[0],s=i[1];n.off(s,this)}}}),i.components={},i.Evented.extend("Component",{init:function(t){this.entity=t,this.extend&&i._extend(t,this.extend),t[this.name]=this,t.activeComponents.push(this.componentName),t.stage&&t.stage.addToList&&t.stage.addToList(this.componentName,t),this.added&&this.added()},destroy:function(){if(this.extend)for(var t=i._keys(this.extend),e=0,n=t.length;n>e;e++)delete this.entity[t[e]];delete this.entity[this.name];var s=this.entity.activeComponents.indexOf(this.componentName);-1!==s&&(this.entity.activeComponents.splice(s,1),this.entity.stage&&this.entity.stage.addToList&&this.entity.stage.addToLists(this.componentName,this.entity)),this.debind(),this.destroyed&&this.destroyed()}}),i.Evented.extend("GameObject",{has:function(t){return this[t]?!0:!1},add:function(t){t=i._normalizeArg(t),this.activeComponents||(this.activeComponents=[]);for(var e=0,n=t.length;n>e;e++){var s=t[e],o=i.components[s];if(!this.has(s)&&o){var r=new o(this);this.trigger("addComponent",r)}}return this},del:function(t){t=i._normalizeArg(t);for(var e=0,n=t.length;n>e;e++){var s=t[e];s&&this.has(s)&&(this.trigger("delComponent",this[s]),this[s].destroy())}return this},destroy:function(){this.isDestroyed||(this.trigger("destroyed"),this.debind(),this.stage&&this.stage.remove&&this.stage.remove(this),this.isDestroyed=!0,this.destroyed&&this.destroyed())}}),i.component=function(t,e){return e?(e.name=t,e.componentName="."+t,i.components[t]=i.Component.extend(t+"Component",e)):i.components[t]},i.GameObject.extend("GameState",{init:function(t){this.p=i._extend({},t),this.listeners={}},reset:function(t){this.init(t),this.trigger("reset")},_triggerProperty:function(t,e){this.p[e]!==t&&(this.p[e]=t,this.trigger("change."+e,t))},set:function(t,e){i._isObject(t)?i._each(t,this._triggerProperty,this):this._triggerProperty(e,t),this.trigger("change")},inc:function(t,e){this.set(t,this.get(t)+e)},dec:function(t,e){this.set(t,this.get(t)-e)},get:function(t){return this.p[t]}}),i.state=new i.GameState,i.reset=function(){i.state.reset()},i.touchDevice="ontouchstart"in document,i.setup=function(t,e){i._isObject(t)&&(e=t,t=null),e=e||{},t=t||"quintus",i.el=i._isString(t)?document.getElementById(t):t,i.el||(i.el=document.createElement("canvas"),i.el.width=e.width||320,i.el.height=e.height||420,i.el.id=t,document.body.appendChild(i.el));var n=parseInt(i.el.width,10),s=parseInt(i.el.height,10),o=e.maxWidth||5e3,r=e.maxHeight||5e3,a=e.resampleWidth,h=e.resampleHeight,l=e.upsampleWidth,c=e.upsampleHeight;e.maximize===!0||i.touchDevice&&"touch"===e.maximize?(document.body.style.padding=0,document.body.style.margin=0,n=e.width||Math.min(window.innerWidth,o)-(e.pagescroll?17:0),s=e.height||Math.min(window.innerHeight-5,r),i.touchDevice&&(i.el.style.height=2*s+"px",window.scrollTo(0,1),n=Math.min(window.innerWidth,o),s=Math.min(window.innerHeight,r))):i.touchDevice&&window.scrollTo(0,1),l&&l>=n||c&&c>=s?(i.el.style.height=s+"px",i.el.style.width=n+"px",i.el.width=2*n,i.el.height=2*s):(a&&n>a||h&&s>h)&&i.touchDevice?(i.el.style.height=s+"px",i.el.style.width=n+"px",i.el.width=n/2,i.el.height=s/2):(i.el.style.height=s+"px",i.el.style.width=n+"px",i.el.width=n,i.el.height=s);var u=i.el.parentNode;if(u&&(i.wrapper=document.createElement("div"),i.wrapper.id=i.el.id+"_container",i.wrapper.style.width=n+"px",i.wrapper.style.margin="0 auto",i.wrapper.style.position="relative",u.insertBefore(i.wrapper,i.el),i.wrapper.appendChild(i.el)),i.el.style.position="relative",i.ctx=i.el.getContext&&i.el.getContext("2d"),i.width=parseInt(i.el.width,10),i.height=parseInt(i.el.height,10),i.cssWidth=n,i.cssHeight=s,e.scaleToFit){var d=1,p=window.innerWidth*d,f=window.innerHeight*d,g=p/f,m=i.el.width/i.el.height,v=g>m?f/i.el.height:p/i.el.width,y=i.el.width*v,x=i.el.height*v;if(i.el.style.width=y+"px",i.el.style.height=x+"px",i.el.parentNode&&(i.el.parentNode.style.width=y+"px",i.el.parentNode.style.height=x+"px"),i.cssWidth=parseInt(y,10),i.cssHeight=parseInt(x,10),m>g){var w=(f-x)/2;i.el.style.top=w+"px"}}return window.addEventListener("orientationchange",function(){setTimeout(function(){window.scrollTo(0,1)},0)}),i},i.clear=function(){i.clearColor?(i.ctx.globalAlpha=1,i.ctx.fillStyle=i.clearColor,i.ctx.fillRect(0,0,i.width,i.height)):i.ctx.clearRect(0,0,i.width,i.height)},i.setImageSmoothing=function(t){i.ctx.mozImageSmoothingEnabled=t,i.ctx.webkitImageSmoothingEnabled=t,i.ctx.msImageSmoothingEnabled=t,i.ctx.imageSmoothingEnabled=t},i.imageData=function(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.drawImage(t,0,0),i.getImageData(0,0,t.width,t.height)},i.assetTypes={png:"Image",jpg:"Image",gif:"Image",jpeg:"Image",ogg:"Audio",wav:"Audio",m4a:"Audio",mp3:"Audio"},i._fileExtension=function(t){var e=t.split("."),i=e[e.length-1].toLowerCase();return i},i.assetType=function(t){var e=i._fileExtension(t),n=i.assetTypes[e];return"Audio"===n&&i.audio&&"WebAudio"===i.audio.type&&(n="WebAudio"),n||"Other"},i.assetUrl=function(t,e){var n="";return i.options.development&&(n=(/\?/.test(e)?"&":"?")+"_t="+(new Date).getTime()),/^https?:\/\//.test(e)||"/"===e[0]?e+n:t+e+n},i.loadAssetImage=function(t,e,n,s){var o=new Image;o.onload=function(){n(t,o)},o.onerror=s,o.src=i.assetUrl(i.options.imagePath,e)},i.audioMimeTypes={mp3:"audio/mpeg",ogg:'audio/ogg; codecs="vorbis"',m4a:"audio/m4a",wav:"audio/wav"},i._audioAssetExtension=function(){if(i._audioAssetPreferredExtension)return i._audioAssetPreferredExtension;var t=new Audio;return i._audioAssetPreferredExtension=i._detect(i.options.audioSupported,function(e){return t.canPlayType(i.audioMimeTypes[e])?e:null})},i.loadAssetAudio=function(t,e,n,s){if(!document.createElement("audio").play||!i.options.sound)return void n(t,null);var o=i._removeExtension(e),r=i._audioAssetExtension(),a=new Audio;return r?(a.addEventListener("error",s),i.touchDevice||a.addEventListener("canplaythrough",function(){n(t,a)}),a.src=i.assetUrl(i.options.audioPath,o+"."+r),a.load(),void(i.touchDevice&&n(t,a))):void n(t,null)},i.loadAssetWebAudio=function(t,e,n,s){var o=new XMLHttpRequest,r=i._removeExtension(e),a=i._audioAssetExtension();o.open("GET",i.assetUrl(i.options.audioPath,r+"."+a),!0),o.responseType="arraybuffer",o.onload=function(){o.response;i.audioContext.decodeAudioData(o.response,function(e){n(t,e)},s)},o.send()},i.loadAssetOther=function(t,e,n,s){var o=new XMLHttpRequest,r=e.split("."),a=r[r.length-1].toLowerCase();return"file://"==document.location.origin||"null"===document.location.origin?(i.fileURLAlert||(i.fileURLAlert=!0,alert("Quintus Error: Loading assets is not supported from file:// urls - please run from a local web-server and try again")),s()):(o.onreadystatechange=function(){4===o.readyState&&(200===o.status?"json"===a?n(t,JSON.parse(o.responseText)):n(t,o.responseText):s())},o.open("GET",i.assetUrl(i.options.dataPath,e),!0),void o.send(null))},i._removeExtension=function(t){return t.replace(/\.(\w{3,4})$/,"")},i.assets={},i.asset=function(t){return i.assets[t]},i.load=function(t,e,n){var s={};n||(n={});var o=n.progressCallback,r=!1,a=function(t){r=!0,(n.errorCallback||function(t){throw"Error Loading: "+t})(t)};i._isString(t)&&(t=i._normalizeArg(t)),i._isArray(t)?i._each(t,function(t){i._isObject(t)?i._extend(s,t):s[t]=t}):s=t;var h=i._keys(s).length,l=h,c=function(t,n,s){r||((!i.assets[t]||s)&&(i.assets[t]=n,l--,o&&o(h-l,h)),0===l&&e&&e.apply(i))};i._each(s,function(t,e){var n=i.assetType(t);i.assets[e]?c(e,i.assets[e],!0):i["loadAsset"+n](e,t,c,function(){a(t)})})},i.preloads=[],i.preload=function(t,e){i._isFunction(t)?(i.load(i._uniq(i.preloads),t,e),i.preloads=[]):i.preloads=i.preloads.concat(t)},i.matrices2d=[],i.matrix2d=function(){return i.matrices2d.length>0?i.matrices2d.pop().identity():new i.Matrix2D},i.Matrix2D=i.Class.extend({init:function(t){t?(this.m=[],this.clone(t)):this.m=[1,0,0,0,1,0]},identity:function(){var t=this.m;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,this},clone:function(t){var e=this.m,i=t.m;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],this},multiply:function(t){var e=this.m,i=t.m,n=e[0]*i[0]+e[1]*i[3],s=e[0]*i[1]+e[1]*i[4],o=e[0]*i[2]+e[1]*i[5]+e[2],r=e[3]*i[0]+e[4]*i[3],a=e[3]*i[1]+e[4]*i[4],h=e[3]*i[2]+e[4]*i[5]+e[5];return e[0]=n,e[1]=s,e[2]=o,e[3]=r,e[4]=a,e[5]=h,this},rotate:function(t){if(0===t)return this;var e=Math.cos(t),i=Math.sin(t),n=this.m,s=n[0]*e+n[1]*i,o=n[0]*-i+n[1]*e,r=n[3]*e+n[4]*i,a=n[3]*-i+n[4]*e;return n[0]=s,n[1]=o,n[3]=r,n[4]=a,this},rotateDeg:function(t){return 0===t?this:this.rotate(Math.PI*t/180)},scale:function(t,e){var i=this.m;return void 0===e&&(e=t),i[0]*=t,i[1]*=e,i[3]*=t,i[4]*=e,this},translate:function(t,e){var i=this.m;return i[2]+=i[0]*t+i[1]*e,i[5]+=i[3]*t+i[4]*e,this},transform:function(t,e){return[t*this.m[0]+e*this.m[1]+this.m[2],t*this.m[3]+e*this.m[4]+this.m[5]]},transformPt:function(t){var e=t.x,i=t.y;return t.x=e*this.m[0]+i*this.m[1]+this.m[2],t.y=e*this.m[3]+i*this.m[4]+this.m[5],t},transformArr:function(t,e){var i=t[0],n=t[1];return e[0]=i*this.m[0]+n*this.m[1]+this.m[2],e[1]=i*this.m[3]+n*this.m[4]+this.m[5],e},transformX:function(t,e){return t*this.m[0]+e*this.m[1]+this.m[2]},transformY:function(t,e){return t*this.m[3]+e*this.m[4]+this.m[5]},release:function(){return i.matrices2d.push(this),null},setContextTransform:function(t){var e=this.m;t.transform(e[0],e[3],e[1],e[4],e[2],e[5])}}),i};!function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),s=window.setTimeout(function(){e(i+n)},n);return t=i+n,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),Quintus["2D"]=function(t){t.component("viewport",{added:function(){this.entity.on("prerender",this,"prerender"),this.entity.on("render",this,"postrender"),this.x=0,this.y=0,this.offsetX=0,this.offsetY=0,this.centerX=t.width/2,this.centerY=t.height/2,this.scale=1},extend:{follow:function(e,i,n){this.off("poststep",this.viewport,"follow"),this.viewport.directions=i||{x:!0,y:!0},this.viewport.following=e,this.viewport.boundingBox=n,this.viewport.boundingBox=t._isUndefined(n)?t._detect(this.lists.TileLayer,function(t){return t.p.boundingBox?{minX:0,maxX:t.p.w,minY:0,maxY:t.p.h}:null}):n,this.on("poststep",this.viewport,"follow"),this.viewport.follow(!0)},unfollow:function(){this.off("poststep",this.viewport,"follow")},centerOn:function(t,e){this.viewport.centerOn(t,e)},moveTo:function(t,e){return this.viewport.moveTo(t,e)}},follow:function(e){var i=t._isFunction(this.directions.x)?this.directions.x(this.following):this.directions.x,n=t._isFunction(this.directions.y)?this.directions.y(this.following):this.directions.y;this[e===!0?"centerOn":"softCenterOn"](i?this.following.p.x+this.following.p.w/2-this.offsetX:void 0,n?this.following.p.y+this.following.p.h/2-this.offsetY:void 0)},offset:function(t,e){this.offsetX=t,this.offsetY=e},softCenterOn:function(e,i){if(void 0!==e){var n=(e-t.width/2/this.scale-this.x)/3;this.boundingBox?this.x+n<this.boundingBox.minX?this.x=this.boundingBox.minX/this.scale:this.x+n>(this.boundingBox.maxX-t.width)/this.scale?this.x=Math.max(this.boundingBox.maxX-t.width,this.boundingBox.minX)/this.scale:this.x+=n:this.x+=n}if(void 0!==i){var s=(i-t.height/2/this.scale-this.y)/3;this.boundingBox?this.y+s<this.boundingBox.minY?this.y=this.boundingBox.minY/this.scale:this.y+s>(this.boundingBox.maxY-t.height)/this.scale?this.y=Math.max(this.boundingBox.maxY-t.height,this.boundingBox.minY)/this.scale:this.y+=s:this.y+=s}},centerOn:function(e,i){void 0!==e&&(this.x=e-t.width/2/this.scale),void 0!==i&&(this.y=i-t.height/2/this.scale)},moveTo:function(t,e){return void 0!==t&&(this.x=t),void 0!==e&&(this.y=e),this.entity},prerender:function(){this.centerX=this.x+t.width/2/this.scale,this.centerY=this.y+t.height/2/this.scale,t.ctx.save(),t.ctx.translate(Math.floor(t.width/2),Math.floor(t.height/2)),t.ctx.scale(this.scale,this.scale),t.ctx.translate(-Math.floor(this.centerX),-Math.floor(this.centerY))},postrender:function(){t.ctx.restore()}}),t.Sprite.extend("TileLayer",{init:function(t){this._super(t,{tileW:32,tileH:32,blockTileW:10,blockTileH:10,type:1,renderAlways:!0}),this.p.dataAsset&&this.load(this.p.dataAsset),this.setDimensions(),this.blocks=[],this.p.blockW=this.p.tileW*this.p.blockTileW,this.p.blockH=this.p.tileH*this.p.blockTileH,this.colBounds={},this.directions=["top","left","right","bottom"],this.tileProperties={},this.collisionObject={p:{w:this.p.tileW,h:this.p.tileH,cx:this.p.tileW/2,cy:this.p.tileH/2}},this.tileCollisionObjects={},this.collisionNormal={separate:[]},this._generateCollisionObjects()},_generateCollisionObjects:function(){function e(t){return[t[0]*i.p.tileW-i.p.tileW/2,t[1]*i.p.tileH-i.p.tileH/2]}var i=this;if(this.sheet()&&this.sheet().frameProperties){var n=this.sheet().frameProperties;for(var s in n){var o=this.tileCollisionObjects[s]={p:t._clone(this.collisionObject.p)};t._extend(o.p,n[s]),o.p.points&&(o.p.points=t._map(o.p.points,e)),this.tileCollisionObjects[s]=o}}},load:function(e){var i,n=e.split("."),s=n[n.length-1].toLowerCase();if("json"!==s)throw"file type not supported";i=t._isString(e)?t.asset(e):e,this.p.tiles=i},setDimensions:function(){var t=this.p.tiles;t&&(this.p.rows=t.length,this.p.cols=t[0].length,this.p.w=this.p.cols*this.p.tileW,this.p.h=this.p.rows*this.p.tileH)},getTile:function(t,e){return this.p.tiles[e]&&this.p.tiles[e][t]},getTileProperty:function(t,e){return void 0!==this.tileProperties[t]?this.tileProperties[t][e]:void 0},getTileProperties:function(t){return void 0!==this.tileProperties[t]?this.tileProperties[t]:{}},getTilePropertyAt:function(t,e,i){return this.getTileProperty(this.getTile(t,e),i)},getTilePropertiesAt:function(t,e){return this.getTileProperties(this.getTile(t,e))},tileHasProperty:function(t,e){return void 0!==this.getTileProperty(t,e)},setTile:function(t,e,i){var n=this.p,s=Math.floor(t/n.blockTileW),o=Math.floor(e/n.blockTileH);t>=0&&t<this.p.cols&&e>=0&&e<this.p.rows&&(this.p.tiles[e][t]=i,this.blocks[o]&&(this.blocks[o][s]=null))},tilePresent:function(t,e){return this.p.tiles[e]&&this.collidableTile(this.p.tiles[e][t])},drawableTile:function(t){return t>0},collidableTile:function(t){return t>0},getCollisionObject:function(t,e){var i,n=this.p,s=this.getTile(t,e);return i=void 0!==this.tileCollisionObjects[s]?this.tileCollisionObjects[s]:this.collisionObject,i.p.x=t*n.tileW+n.x+n.tileW/2,i.p.y=e*n.tileH+n.y+n.tileH/2,i},collide:function(e){var i,n,s=this.p,o=e.c||e.p,r=Math.floor((o.x-o.cx-s.x)/s.tileW),a=Math.floor((o.y-o.cy-s.y)/s.tileH),h=Math.ceil((o.x-o.cx+o.w-s.x)/s.tileW),l=Math.ceil((o.y-o.cy+o.h-s.y)/s.tileH),c=this.collisionNormal;c.collided=!1;for(var u=a;l>=u;u++)for(var d=r;h>=d;d++)this.tilePresent(d,u)&&(n=this.getCollisionObject(d,u),i=t.collision(e,n),i&&i.magnitude>0&&(n.p.sensor?(n.tile=this.getTile(d,u),e.trigger&&e.trigger("sensor.tile",n)):(!c.collided||c.magnitude<i.magnitude)&&(c.collided=!0,c.separate[0]=i.separate[0],c.separate[1]=i.separate[1],c.magnitude=i.magnitude,c.distance=i.distance,c.normalX=i.normalX,c.normalY=i.normalY,c.tileX=d,c.tileY=u,c.tile=this.getTile(d,u),void 0!==e.p.collisions&&e.p.collisions.push(c))));return c.collided?c:!1},prerenderBlock:function(t,e){var i=this.p,n=i.tiles,s=this.sheet(),o=t*i.blockTileW,r=e*i.blockTileH;if(!(0>o||o>=this.p.cols||0>r||r>=this.p.rows)){var a=document.createElement("canvas"),h=a.getContext("2d");a.width=i.blockW,a.height=i.blockH,this.blocks[e]=this.blocks[e]||{},this.blocks[e][t]=a;for(var l=0;l<i.blockTileH;l++)if(n[l+r])for(var c=0;c<i.blockTileW;c++)this.drawableTile(n[l+r][c+o])&&s.draw(h,c*i.tileW,l*i.tileH,n[l+r][c+o])}},drawBlock:function(t,e,i){var n=this.p,s=Math.floor(e*n.blockW+n.x),o=Math.floor(i*n.blockH+n.y);this.blocks[i]&&this.blocks[i][e]||this.prerenderBlock(e,i),this.blocks[i]&&this.blocks[i][e]&&t.drawImage(this.blocks[i][e],s,o)},draw:function(e){for(var i=this.p,n=this.stage.viewport,s=n?n.scale:1,o=n?n.x:0,r=n?n.y:0,a=t.width/s,h=t.height/s,l=Math.floor((o-i.x)/i.blockW),c=Math.floor((r-i.y)/i.blockH),u=Math.floor((o+a-i.x)/i.blockW),d=Math.floor((r+h-i.y)/i.blockH),p=c;d>=p;p++)for(var f=l;u>=f;f++)this.drawBlock(e,f,p)}}),t.gravityY=9.8*100,t.gravityX=0,t.component("2d",{added:function(){var e=this.entity;t._defaults(e.p,{vx:0,vy:0,ax:0,ay:0,gravity:1,collisionMask:t.SPRITE_DEFAULT}),e.on("step",this,"step"),e.on("hit",this,"collision")},collision:function(t){var e=this.entity,i=e.p;if(t.obj.p&&t.obj.p.sensor)return void t.obj.trigger("sensor",e);t.impact=0;var n=Math.abs(i.vx),s=Math.abs(i.vy);i.x-=t.separate[0],i.y-=t.separate[1],t.normalY<-.3&&(!i.skipCollide&&i.vy>0&&(i.vy=0),t.impact=s,e.trigger("bump.bottom",t)),t.normalY>.3&&(!i.skipCollide&&i.vy<0&&(i.vy=0),t.impact=s,e.trigger("bump.top",t)),t.normalX<-.3&&(!i.skipCollide&&i.vx>0&&(i.vx=0),t.impact=n,e.trigger("bump.right",t)),t.normalX>.3&&(!i.skipCollide&&i.vx<0&&(i.vx=0),t.impact=n,e.trigger("bump.left",t))},step:function(e){for(var i=this.entity.p,n=e;n>0;)e=Math.min(1/30,n),i.vx+=i.ax*e+(void 0===i.gravityX?t.gravityX:i.gravityX)*e*i.gravity,i.vy+=i.ay*e+(void 0===i.gravityY?t.gravityY:i.gravityY)*e*i.gravity,i.x+=i.vx*e,i.y+=i.vy*e,this.entity.stage.collide(this.entity),n-=e}}),t.component("aiBounce",{added:function(){this.entity.on("bump.right",this,"goLeft"),this.entity.on("bump.left",this,"goRight")},goLeft:function(t){this.entity.p.vx=-t.impact,this.entity.p.flip="right"===this.entity.p.defaultDirection?"x":!1},goRight:function(t){this.entity.p.vx=t.impact,this.entity.p.flip="left"===this.entity.p.defaultDirection?"x":!1}})},Quintus.Anim=function(t){t._animations={},t.animations=function(e,i){t._animations[e]||(t._animations[e]={}),t._extend(t._animations[e],i)},t.animation=function(e,i){return t._animations[e]&&t._animations[e][i]},t.component("animation",{added:function(){var t=this.entity.p;t.animation=null,t.animationPriority=-1,t.animationFrame=0,t.animationTime=0,this.entity.on("step",this,"step")},extend:{play:function(t,e,i){this.animation.play(t,e,i)}},step:function(e){var i=this.entity,n=i.p;if(n.animation){var s=t.animation(n.sprite,n.animation),o=s.rate||n.rate,r=0;if(n.animationTime+=e,n.animationChanged?n.animationChanged=!1:(n.animationTime+=e,n.animationTime>o&&(r=Math.floor(n.animationTime/o),n.animationTime-=r*o,n.animationFrame+=r)),r>0){if(n.animationFrame>=s.frames.length){if(s.loop===!1||s.next)return n.animationFrame=s.frames.length-1,i.trigger("animEnd"),i.trigger("animEnd."+n.animation),n.animation=null,n.animationPriority=-1,s.trigger&&i.trigger(s.trigger,s.triggerData),void(s.next&&this.play(s.next,s.nextPriority));i.trigger("animLoop"),i.trigger("animLoop."+n.animation),n.animationFrame=n.animationFrame%s.frames.length}i.trigger("animFrame")}n.sheet=s.sheet||n.sheet,n.frame=s.frames[n.animationFrame],s.hasOwnProperty("flip")&&(n.flip=s.flip)}},play:function(t,e,i){var n=this.entity,s=n.p;e=e||0,t!==s.animation&&e>=s.animationPriority&&(void 0===i&&(i=!0),s.animation=t,i&&(s.animationChanged=!0,s.animationTime=0,s.animationFrame=0),s.animationPriority=e,n.trigger("anim"),n.trigger("anim."+s.animation))}}),t.Sprite.extend("Repeater",{init:function(e){this._super(t._defaults(e,{speedX:1,speedY:1,repeatY:!0,repeatX:!0,renderAlways:!0,type:0})),this.p.repeatW=this.p.repeatW||this.p.w,this.p.repeatH=this.p.repeatH||this.p.h},draw:function(e){var i,n,s,o=this.p,r=this.asset(),a=this.sheet(),h=this.stage.viewport?this.stage.viewport.scale:1,l=Math.floor(this.stage.viewport?this.stage.viewport.x:0),c=Math.floor(this.stage.viewport?this.stage.viewport.y:0),u=Math.floor(o.x+l*this.p.speedX),d=Math.floor(o.y+c*this.p.speedY);for(o.repeatX?(i=-u%o.repeatW,i>0&&(i-=o.repeatW)):i=o.x-l,o.repeatY?(n=-d%o.repeatH,n>0&&(n-=o.repeatH)):n=o.y-c,s=i;n<t.height/h;){for(i=s;i<t.width/h&&(a?a.draw(e,i+l,n+c,o.frame):e.drawImage(r,i+l,n+c),i+=o.repeatW,o.repeatX););if(n+=o.repeatH,!o.repeatY)break}}}),t.Tween=t.Class.extend({init:function(e,i,n,s,o){t._isObject(s)&&(o=s,s=t.Easing.Linear),t._isObject(n)&&(o=n,n=1),this.entity=e,this.duration=n||1,this.time=0,this.options=o||{},this.delay=this.options.delay||0,this.easing=s||this.options.easing||t.Easing.Linear,this.startFrame=t._loopFrame+1,this.properties=i,this.start={},this.diff={}},step:function(e){var i;if(this.startFrame>t._loopFrame)return!0;if(this.delay>=e)return this.delay-=e,!0;if(this.delay>0&&(e-=this.delay,this.delay=0),0===this.time){var n=this.entity,s=this.properties;this.p=n instanceof t.Stage?n.viewport:n.p;for(i in s)this.start[i]=this.p[i],t._isUndefined(this.start[i])||(this.diff[i]=s[i]-this.start[i])}this.time+=e;var o=Math.min(1,this.time/this.duration),r=this.easing(o);for(i in this.start)t._isUndefined(this.p[i])||(this.p[i]=this.start[i]+this.diff[i]*r);return o>=1&&this.options.callback&&this.options.callback.apply(this.entity),1>o}}),t.Easing={Linear:function(t){return t},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}}},t.component("tween",{added:function(){this._tweens=[],this.entity.on("step",this,"step")},extend:{animate:function(e,i,n,s){return this.tween._tweens.push(new t.Tween(this,e,i,n,s)),this},chain:function(e,i,n,s){t._isObject(n)&&(s=n,n=t.Easing.Linear);var o=this.tween._tweens.length;if(o>0){var r=this.tween._tweens[o-1];s=s||{},s.delay=r.duration-r.time+r.delay}return this.animate(e,i,n,s),this},stop:function(){return this.tween._tweens.length=0,this}},step:function(t){for(var e=0;e<this._tweens.length;e++)this._tweens[e].step(t)||(this._tweens.splice(e,1),e--)}})},Quintus.Audio=function(t){t.audio={channels:[],channelMax:t.options.channelMax||10,active:{},play:function(){},stop:function(){}},t.hasWebAudio="undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext,t.hasWebAudio&&(t.audioContext="undefined"!=typeof AudioContext?new AudioContext:new window.webkitAudioContext),t.enableSound=function(){!!("ontouchstart"in window);return t.hasWebAudio?t.audio.enableWebAudioSound():t.audio.enableHTML5Sound(),t},t.audio.enableWebAudioSound=function(){t.audio.type="WebAudio",t.audio.soundID=0,t.audio.playingSounds={},t.audio.removeSound=function(e){delete t.audio.playingSounds[e]},t.audio.play=function(e,i){var n=(new Date).getTime();if(!(t.audio.active[e]&&t.audio.active[e]>n)){i&&i.debounce?t.audio.active[e]=n+i.debounce:delete t.audio.active[e];var s=t.audio.soundID++,o=t.audioContext.createBufferSource();o.buffer=t.asset(e),o.connect(t.audioContext.destination),i&&i.loop?o.loop=!0:setTimeout(function(){t.audio.removeSound(s)},1e3*o.buffer.duration),o.assetName=e,o.start?o.start(0):o.noteOn(0),t.audio.playingSounds[s]=o}},t.audio.stop=function(e){for(var i in t.audio.playingSounds){var n=t.audio.playingSounds[i];e&&e!==n.assetName||(n.stop?n.stop(0):n.noteOff(0))}}},t.audio.enableHTML5Sound=function(){t.audio.type="HTML5";for(var e=0;e<t.audio.channelMax;e++)t.audio.channels[e]={},t.audio.channels[e].channel=new Audio,t.audio.channels[e].finished=-1;t.audio.play=function(e,i){var n=(new Date).getTime();if(!(t.audio.active[e]&&t.audio.active[e]>n)){i&&i.debounce?t.audio.active[e]=n+i.debounce:delete t.audio.active[e];for(var s=0;s<t.audio.channels.length;s++)if(!t.audio.channels[s].loop&&t.audio.channels[s].finished<n){t.audio.channels[s].channel.src=t.asset(e).src,i&&i.loop?(t.audio.channels[s].loop=!0,t.audio.channels[s].channel.loop=!0):t.audio.channels[s].finished=n+1e3*t.asset(e).duration,t.audio.channels[s].channel.load(),t.audio.channels[s].channel.play();break}}},t.audio.stop=function(e){for(var i=e?t.asset(e).src:null,n=(new Date).getTime(),s=0;s<t.audio.channels.length;s++)i&&t.audio.channels[s].channel.src!==i||!(t.audio.channels[s].loop||t.audio.channels[s].finished>=n)||(t.audio.channels[s].channel.pause(),t.audio.channels[s].loop=!1)}}},Quintus.Input=function(t){var e=t.KEY_NAMES={LEFT:37,RIGHT:39,UP:38,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ENTER:13,ESC:27,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,SPACE:32,HOME:36,END:35,PGGUP:33,PGDOWN:34},i={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",SPACE:"fire",Z:"fire",X:"action",ENTER:"confirm",ESC:"esc",P:"P",S:"S",A:"A",D:"D"},n=[["left","<"],["right",">"],[],["action","b"],["fire","a"]],s=["up","right","down","left"];t.inputs={},t.joypad={};var o=!!("ontouchstart"in window);t.canvasToStageX=function(e,i){return e=e/t.cssWidth*t.width,i.viewport&&(e/=i.viewport.scale,e+=i.viewport.x),e},t.canvasToStageY=function(e,i){return e=e/t.cssWidth*t.width,i.viewport&&(e/=i.viewport.scale,e+=i.viewport.y),e},t.InputSystem=t.Evented.extend({keys:{},keypad:{},keyboardEnabled:!1,touchEnabled:!1,joypadEnabled:!1,bindKey:function(i,n){t.input.keys[e[i]||i]=n},enableKeyboard:function(){return this.keyboardEnabled?!1:(t.el.tabIndex=0,t.el.style.outline=0,t.el.addEventListener("keydown",function(e){if(t.input.keys[e.keyCode]){var i=t.input.keys[e.keyCode];t.inputs[i]=!0,t.input.trigger(i),t.input.trigger("keydown",e.keyCode)}e.ctrlKey||e.preventDefault()},!1),t.el.addEventListener("keyup",function(e){if(t.input.keys[e.keyCode]){var i=t.input.keys[e.keyCode];t.inputs[i]=!1,t.input.trigger(i+"Up"),t.input.trigger("keyup",e.keyCode)}e.preventDefault()},!1),t.options.autoFocus&&t.el.focus(),void(this.keyboardEnabled=!0))},keyboardControls:function(e){e=e||i,t._each(e,function(t,e){this.bindKey(e,t)},t.input),this.enableKeyboard()},_containerOffset:function(){t.input.offsetX=0,t.input.offsetY=0;var e=t.el;do t.input.offsetX+=e.offsetLeft,t.input.offsetY+=e.offsetTop;while(e=e.offsetParent)},touchLocation:function(e){var i,n,s=(t.el,e.offsetX),o=e.offsetY;return(t._isUndefined(s)||t._isUndefined(o))&&(s=e.layerX,o=e.layerY),(t._isUndefined(s)||t._isUndefined(o))&&(void 0===t.input.offsetX&&t.input._containerOffset(),s=e.pageX-t.input.offsetX,o=e.pageY-t.input.offsetY),i=t.width*s/t.cssWidth,n=t.height*o/t.cssHeight,{x:i,y:n}},touchControls:function(e){function i(i){for(var n=t.input.touchLocation(i),s=e.bottom-e.unit,o=0,r=e.controls.length;r>o;o++){var a=o*e.unit+e.gutter;if(n.x>=a&&n.x<=a+e.size&&(e.fullHeight||n.y>=s+e.gutter&&n.y<=s+e.unit-e.gutter))return e.controls[o][0]}}function s(n){var s,o,r,a,h,l={};for(s=0,o=e.controls.length;o>s;s++)h=e.controls[s][0],t.inputs[h]&&(l[h]=!0),t.inputs[h]=!1;var c=n.touches?n.touches:[n];for(s=0,o=c.length;o>s;s++)r=c[s],a=i(r),a&&(t.inputs[a]=!0,l[a]?delete l[a]:t.input.trigger(a));for(h in l)t.input.trigger(h+"Up");return null}return this.touchEnabled?!1:o?(t.input.keypad=e=t._extend({left:0,gutter:10,controls:n,width:t.width,bottom:t.height,fullHeight:!1},e),e.unit=e.width/e.controls.length,e.size=e.unit-2*e.gutter,this.touchDispatchHandler=function(t){s(t),t.preventDefault()},t._each(["touchstart","touchend","touchmove","touchcancel"],function(e){t.el.addEventListener(e,this.touchDispatchHandler)
},this),void(this.touchEnabled=!0)):!1},disableTouchControls:function(){t._each(["touchstart","touchend","touchmove","touchcancel"],function(e){t.el.removeEventListener(e,this.touchDispatchHandler)},this),t.el.removeEventListener("touchstart",this.joypadStart),t.el.removeEventListener("touchmove",this.joypadMove),t.el.removeEventListener("touchend",this.joypadEnd),t.el.removeEventListener("touchcancel",this.joypadEnd),this.touchEnabled=!1;for(var e in t.inputs)t.inputs[e]=!1},joypadControls:function(e){if(this.joypadEnabled)return!1;if(!o)return!1;var i=t.joypad=t._defaults(e||{},{size:50,trigger:20,center:25,color:"#CCC",background:"#000",alpha:.5,zone:t.width/2,joypadTouch:null,inputs:s,triggers:[]});this.joypadStart=function(e){if(null===i.joypadTouch){var n=e.changedTouches[0],s=t.input.touchLocation(n);s.x<i.zone&&(i.joypadTouch=n.identifier,i.centerX=s.x,i.centerY=s.y,i.x=null,i.y=null)}},this.joypadMove=function(e){if(null!==i.joypadTouch)for(var n=e,s=0,o=n.changedTouches.length;o>s;s++){var r=n.changedTouches[s];if(r.identifier===i.joypadTouch){var a=t.input.touchLocation(r),h=a.x-i.centerX,l=a.y-i.centerY,c=Math.sqrt(h*h+l*l),u=Math.max(1,c/i.size),d=Math.atan2(h,l);u>1&&(h/=u,l/=u,c/=u);for(var p=[l<-i.trigger,h>i.trigger,l>i.trigger,h<-i.trigger],f=0;f<p.length;f++){var g=i.inputs[f];p[f]?(t.inputs[g]=!0,i.triggers[f]||t.input.trigger(g)):(t.inputs[g]=!1,i.triggers[f]&&t.input.trigger(g+"Up"))}t._extend(i,{dx:h,dy:l,x:i.centerX+h,y:i.centerY+l,dist:c,ang:d,triggers:p});break}}e.preventDefault()},this.joypadEnd=function(e){var n=e;if(null!==i.joypadTouch)for(var s=0,o=n.changedTouches.length;o>s;s++){var r=n.changedTouches[s];if(r.identifier===i.joypadTouch){for(var a=0;a<i.triggers.length;a++){var h=i.inputs[a];t.inputs[h]=!1,i.triggers[a]&&t.input.trigger(h+"Up")}i.joypadTouch=null;break}}e.preventDefault()},t.el.addEventListener("touchstart",this.joypadStart),t.el.addEventListener("touchmove",this.joypadMove),t.el.addEventListener("touchend",this.joypadEnd),t.el.addEventListener("touchcancel",this.joypadEnd),this.joypadEnabled=!0},mouseControls:function(e){e=e||{};var i=e.stageNum||0,n=e.mouseX||"mouseX",s=e.mouseY||"mouseY",o=e.cursor||"off",r={};"on"!==o&&(t.el.style.cursor="off"===o?"none":o),t.inputs[n]=0,t.inputs[s]=0,t._mouseMove=function(e){e.preventDefault();var o=e.touches?e.touches[0]:e,a=t.el,h=a.getBoundingClientRect(),l=window.getComputedStyle(a),c=o.clientX-h.left-parseInt(l.paddingLeft),u=o.clientY-h.top-parseInt(l.paddingTop),d=t.stage(i);(t._isUndefined(c)||t._isUndefined(u))&&(c=o.offsetX,u=o.offsetY),(t._isUndefined(c)||t._isUndefined(u))&&(c=o.layerX,u=o.layerY),(t._isUndefined(c)||t._isUndefined(u))&&(void 0===t.input.offsetX&&t.input._containerOffset(),c=o.pageX-t.input.offsetX,u=o.pageY-t.input.offsetY),d&&(r.x=t.canvasToStageX(c,d),r.y=t.canvasToStageY(u,d),t.inputs[n]=r.x,t.inputs[s]=r.y,t.input.trigger("mouseMove",r))},t.el.addEventListener("mousemove",t._mouseMove,!0),t.el.addEventListener("touchstart",t._mouseMove,!0),t.el.addEventListener("touchmove",t._mouseMove,!0)},disableMouseControls:function(){t._mouseMove&&(t.el.removeEventListener("mousemove",t._mouseMove,!0),t.el.style.cursor="inherit",t._mouseMove=null)},drawButtons:function(){var e=t.input.keypad,i=t.ctx;i.save(),i.textAlign="center",i.textBaseline="middle";for(var n=0;n<e.controls.length;n++){var s=e.controls[n];if(s[0]){i.font="bold "+e.size/2+"px arial";var o=e.left+n*e.unit+e.gutter,r=e.bottom-e.unit,a=t.inputs[s[0]];i.fillStyle=e.color||"#FFFFFF",i.globalAlpha=a?1:.5,i.fillRect(o,r,e.size,e.size),i.fillStyle=e.text||"#000000",i.fillText(s[1],o+e.size/2,r+e.size/2)}}i.restore()},drawCircle:function(e,i,n,s){var o=t.ctx,r=t.joypad;o.save(),o.beginPath(),o.globalAlpha=r.alpha,o.fillStyle=n,o.arc(e,i,s,0,2*Math.PI,!0),o.closePath(),o.fill(),o.restore()},drawJoypad:function(){var e=t.joypad;null!==e.joypadTouch&&(t.input.drawCircle(e.centerX,e.centerY,e.background,e.size),null!==e.x&&t.input.drawCircle(e.x,e.y,e.color,e.center))},drawCanvas:function(){this.touchEnabled&&this.drawButtons(),this.joypadEnabled&&this.drawJoypad()}}),t.input=new t.InputSystem,t.controls=function(e){return t.input.keyboardControls(),e?(t.input.touchControls({controls:[[],[],[],["action","b"],["fire","a"]]}),t.input.joypadControls()):t.input.touchControls(),t},t.component("platformerControls",{defaults:{speed:200,jumpSpeed:-300,collisions:[]},added:function(){var e=this.entity.p;t._defaults(e,this.defaults),this.entity.on("step",this,"step"),this.entity.on("bump.bottom",this,"landed"),e.landed=0,e.direction="right"},landed:function(){var t=this.entity.p;t.landed=.2},step:function(e){var i=this.entity.p;if(void 0===i.ignoreControls||!i.ignoreControls){var n=null;if(void 0!==i.collisions&&i.collisions.length>0&&(t.inputs.left||t.inputs.right||i.landed>0)){if(1===i.collisions.length)n=i.collisions[0];else{n=null;for(var s=0;s<i.collisions.length;s++)i.collisions[s].normalY<0&&(n=i.collisions[s])}null!==n&&n.normalY>-.3&&n.normalY<.3&&(n=null)}t.inputs.left?(i.direction="left",n&&i.landed>0?(i.vx=i.speed*n.normalY,i.vy=-i.speed*n.normalX):i.vx=-i.speed):t.inputs.right?(i.direction="right",n&&i.landed>0?(i.vx=-i.speed*n.normalY,i.vy=i.speed*n.normalX):i.vx=i.speed):(i.vx=0,n&&i.landed>0&&(i.vy=0)),i.landed>0&&(t.inputs.up||t.inputs.action)&&!i.jumping?(i.vy=i.jumpSpeed,i.landed=-e,i.jumping=!0):(t.inputs.up||t.inputs.action)&&(this.entity.trigger("jump",this.entity),i.jumping=!0),!i.jumping||t.inputs.up||t.inputs.action||(i.jumping=!1,this.entity.trigger("jumped",this.entity),i.vy<i.jumpSpeed/3&&(i.vy=i.jumpSpeed/3))}i.landed-=e}}),t.component("stepControls",{added:function(){var t=this.entity.p;t.stepDistance||(t.stepDistance=32),t.stepDelay||(t.stepDelay=.2),t.stepWait=0,this.entity.on("step",this,"step"),this.entity.on("hit",this,"collision")},collision:function(){var t=this.entity.p;t.stepping&&(t.stepping=!1,t.x=t.origX,t.y=t.origY)},step:function(e){var i=this.entity.p;i.stepWait-=e,i.stepping&&(i.x+=i.diffX*e/i.stepDelay,i.y+=i.diffY*e/i.stepDelay),i.stepWait>0||(i.stepping&&(i.x=i.destX,i.y=i.destY),i.stepping=!1,i.diffX=0,i.diffY=0,t.inputs.left?i.diffX=-i.stepDistance:t.inputs.right&&(i.diffX=i.stepDistance),t.inputs.up?i.diffY=-i.stepDistance:t.inputs.down&&(i.diffY=i.stepDistance),(i.diffY||i.diffX)&&(i.stepping=!0,i.origX=i.x,i.origY=i.y,i.destX=i.x+i.diffX,i.destY=i.y+i.diffY,i.stepWait=i.stepDelay))}})},Quintus.Scenes=function(t){t.scenes={},t.stages=[],t.Class.extend("Scene",{init:function(t,e){this.opts=e||{},this.sceneFunc=t}}),t.scene=function(e,i,n){return void 0===i?t.scenes[e]:(t._isFunction(i)&&(i=new t.Scene(i,n),i.name=e),t.scenes[e]=i,i)},t._nullContainer={c:{x:0,y:0,angle:0,scale:1},matrix:t.matrix2d()},t.collision=function(){function e(t,e){var i=t[e],n=t[e+1]||t[0];o=-(n[1]-i[1]),r=n[0]-i[0];var s=Math.sqrt(o*o+r*r);s>0&&(o/=s,r/=s)}function i(t){return o*t[0]+r*t[1]}function n(t,n,s){var c,u,d,p,f,g,m,v,y,x,w,b,_,T,S=Number.POSITIVE_INFINITY,E=!1,C=s?l:h;for(a[0]=0,a[1]=0,t.c?_=t.c.points:(_=t.p.points,a[0]+=t.p.x,a[1]+=t.p.y),n.c?T=n.c.points:(T=n.p.points,a[0]+=-n.p.x,a[1]+=-n.p.y),t=t.p,n=n.p,y=0;y<_.length;y++){for(e(_,y),c=i(_[0]),u=c,x=1;x<_.length;x++)v=i(_[x]),c>v&&(c=v),v>u&&(u=v);for(d=i(T[0]),p=d,x=1;x<T.length;x++)v=i(T[x]),d>v&&(d=v),v>p&&(p=v);if(m=i(a),c+=m,u+=m,f=c-p,g=d-u,f>0||g>0)return null;w=-1*(p-c),s&&(w*=-1),b=Math.abs(w),S>b&&(C.distance=w,C.magnitude=b,C.normalX=o,C.normalY=r,C.distance>0&&(C.distance*=-1,C.normalX*=-1,C.normalY*=-1),E=!0,S=b)}return E?C:null}function s(e,i){var s,o,r;return e.p.points||t._generatePoints(e),i.p.points||t._generatePoints(i),(s=n(e,i))&&(o=n(i,e,!0))?(r=o.magnitude<s.magnitude?o:s,0===r.magnitude?!1:(r.separate[0]=r.distance*r.normalX,r.separate[1]=r.distance*r.normalY,r)):!1}var o,r,a=[0,0],h={separate:[]},l={separate:[]};return s}(),t.overlap=function(t,e){var i=t.c||t.p||t,n=e.c||e.p||e,s=i.x-(i.cx||0),o=i.y-(i.cy||0),r=n.x-(n.cx||0),a=n.y-(n.cy||0);return!(o+i.h<a||o>a+n.h||s+i.w<r||s>r+n.w)},t.Stage=t.GameObject.extend({defaults:{sort:!1,gridW:400,gridH:400,x:0,y:0},init:function(e,i){this.scene=e,this.items=[],this.lists={},this.index={},this.removeList=[],this.grid={},this._collisionLayers=[],this.time=0,this.defaults.w=t.width,this.defaults.h=t.height,this.options=t._extend({},this.defaults),this.scene&&t._extend(this.options,e.opts),i&&t._extend(this.options,i),this.options.sort&&!t._isFunction(this.options.sort)&&(this.options.sort=function(t,e){return(t.p&&t.p.z||-1)-(e.p&&e.p.z||-1)})},destroyed:function(){this.invoke("debind"),this.trigger("destroyed")},loadScene:function(){this.scene&&this.scene.sceneFunc(this)},loadAssets:function(e){for(var i=t._isArray(e)?e:t.asset(e),n=0;n<i.length;n++){var s=i[n][0],o=i[n][1];this.insert(new t[s](o))}},each:function(t){for(var e=0,i=this.items.length;i>e;e++)t.call(this.items[e],arguments[1],arguments[2])},invoke:function(t){for(var e=0,i=this.items.length;i>e;e++)this.items[e][t].call(this.items[e],arguments[1],arguments[2])},detect:function(t){for(var e=this.items.length-1;e>=0;e--)if(t.call(this.items[e],arguments[1],arguments[2],arguments[3]))return this.items[e];return!1},identify:function(t){for(var e,i=this.items.length-1;i>=0;i--)if(e=t.call(this.items[i],arguments[1],arguments[2],arguments[3]))return e;return!1},find:function(t){return this.index[t]},addToLists:function(t,e){for(var i=0;i<t.length;i++)this.addToList(t[i],e)},addToList:function(t,e){this.lists[t]||(this.lists[t]=[]),this.lists[t].push(e)},removeFromLists:function(t,e){for(var i=0;i<t.length;i++)this.removeFromList(t[i],e)},removeFromList:function(t,e){var i=this.lists[t].indexOf(e);-1!==i&&this.lists[t].splice(i,1)},insert:function(e,i){return this.items.push(e),e.stage=this,e.container=i,i&&i.children.push(e),e.grid={},t._generatePoints(e),t._generateCollisionPoints(e),e.className&&this.addToList(e.className,e),e.activeComponents&&this.addToLists(e.activeComponents,e),e.p&&(this.index[e.p.id]=e),this.trigger("inserted",e),e.trigger("inserted",this),this.regrid(e),e},remove:function(t){this.delGrid(t),this.removeList.push(t)},forceRemove:function(t){var e=this.items.indexOf(t);if(-1!==e){if(this.items.splice(e,1),t.className&&this.removeFromList(t.className,t),t.activeComponents&&this.removeFromLists(t.activeComponents,t),t.container){var i=t.container.children.indexOf(t);-1!==i&&t.container.children.splice(i,1)}t.destroy&&t.destroy(),t.p.id&&delete this.index[t.p.id],this.trigger("removed",t)}},pause:function(){this.paused=!0},unpause:function(){this.paused=!1},_gridCellCheck:function(e,i,n,s){if(t._isUndefined(s)||s&e){var o=this.index[i];if(o&&o!==n&&t.overlap(n,o)){var r=t.collision(n,o);return r?(r.obj=o,r):!1}}},gridTest:function(e,i){for(var n,s,o=e.grid,r=o.Y1;r<=o.Y2;r++)if(this.grid[r])for(var a=o.X1;a<=o.X2;a++)if(n=this.grid[r][a],n&&(s=t._detect(n,this._gridCellCheck,this,e,i)))return s;return!1},collisionLayer:function(t){return this._collisionLayers.push(t),t.collisionLayer=!0,this.insert(t)},_collideCollisionLayer:function(t,e){for(var i,n=0,s=this._collisionLayers.length;s>n;n++){var o=this._collisionLayers[n];if(o.p.type&e&&(i=o.collide(t)))return i.obj=o,i}return!1},search:function(e,i){var n;return e.grid||this.regrid(e,e.stage!==this),i=t._isUndefined(i)?e.p&&e.p.collisionMask:i,n=this._collideCollisionLayer(e,i),n=n||this.gridTest(e,i)},_locateObj:{p:{x:0,y:0,cx:0,cy:0,w:1,h:1},grid:{}},locate:function(t,e,i){var n=null;return this._locateObj.p.x=t,this._locateObj.p.y=e,this.regrid(this._locateObj,!0),n=this._collideCollisionLayer(this._locateObj,i),n=n||this.gridTest(this._locateObj,i),n&&n.obj?n.obj:!1},collide:function(e,i){var n,s,o,r,a,h;for(t._isObject(i)?(o=i.collisionMask,r=i.maxCol,h=i.skipEvents):o=i,o=t._isUndefined(o)?e.p&&e.p.collisionMask:o,r=r||3,t._generateCollisionPoints(e),this.regrid(e),a=r;a>0&&(n=this._collideCollisionLayer(e,o));)h||(e.trigger("hit",n),e.trigger("hit.collision",n)),t._generateCollisionPoints(e),this.regrid(e),a--;for(a=r;a>0&&(s=this.gridTest(e,o));){if(e.trigger("hit",s),e.trigger("hit.sprite",s),!h){var l=s.obj;s.obj=e,s.normalX*=-1,s.normalY*=-1,s.distance=0,s.magnitude=0,s.separate[0]=0,s.separate[1]=0,l.trigger("hit",s),l.trigger("hit.sprite",s)}t._generateCollisionPoints(e),this.regrid(e),a--}return s||n},delGrid:function(t){for(var e=t.grid,i=e.Y1;i<=e.Y2;i++)if(this.grid[i])for(var n=e.X1;n<=e.X2;n++)this.grid[i][n]&&delete this.grid[i][n][t.p.id]},addGrid:function(t){for(var e=t.grid,i=e.Y1;i<=e.Y2;i++){this.grid[i]||(this.grid[i]={});for(var n=e.X1;n<=e.X2;n++)this.grid[i][n]||(this.grid[i][n]={}),this.grid[i][n][t.p.id]=t.p.type}},regrid:function(t,e){if(!t.collisionLayer){t.grid=t.grid||{};var i=t.c||t.p,n=Math.floor((i.x-i.cx)/this.options.gridW),s=Math.floor((i.y-i.cy)/this.options.gridH),o=Math.floor((i.x-i.cx+i.w)/this.options.gridW),r=Math.floor((i.y-i.cy+i.h)/this.options.gridH),a=t.grid;(a.X1!==n||a.X2!==o||a.Y1!==s||a.Y2!==r)&&(void 0!==a.X1&&this.delGrid(t),a.X1=n,a.X2=o,a.Y1=s,a.Y2=r,e||this.addGrid(t))}},markSprites:function(e,i){for(var n,s,o=this.viewport,r=o?o.scale:1,a=o?o.x:0,h=o?o.y:0,l=t.width/r,c=t.height/r,u=Math.floor(a/this.options.gridW),d=Math.floor(h/this.options.gridH),p=Math.floor((a+l)/this.options.gridW),f=Math.floor((h+c)/this.options.gridH),g=d;f>=g;g++)if(n=this.grid[g])for(var m=u;p>=m;m++)if(s=n[m])for(var v in s)this.index[v]&&(this.index[v].mark=i,this.index[v].container&&(this.index[v].container.mark=i))},updateSprites:function(e,i,n){for(var s,o=0,r=e.length;r>o;o++)s=e[o],(n||!s.p.visibleOnly||s.mark&&!(s.mark<this.time))&&(n||!s.container)&&(s.update(i),t._generateCollisionPoints(s),this.regrid(s))},step:function(t){if(this.paused)return!1;if(this.time+=t,this.markSprites(this.items,this.time),this.trigger("prestep",t),this.updateSprites(this.items,t),this.trigger("step",t),this.removeList.length>0){for(var e=0,i=this.removeList.length;i>e;e++)this.forceRemove(this.removeList[e]);this.removeList.length=0}this.trigger("poststep",t)},hide:function(){this.hidden=!0},show:function(){this.hidden=!1},stop:function(){this.hide(),this.pause()},start:function(){this.show(),this.unpause()},render:function(t){if(this.hidden)return!1;this.options.sort&&this.items.sort(this.options.sort),this.trigger("prerender",t),this.trigger("beforerender",t);for(var e=0,i=this.items.length;i>e;e++){var n=this.items[e];!n.container&&(n.p.renderAlways||n.mark>=this.time)&&n.render(t)}this.trigger("render",t),this.trigger("postrender",t)}}),t.activeStage=0,t.StageSelector=t.Class.extend({emptyList:[],init:function(t,e){this.stage=t,this.selector=e,this.items=this.stage.lists[this.selector]||this.emptyList,this.length=this.items.length},each:function(t){for(var e=0,i=this.items.length;i>e;e++)t.call(this.items[e],arguments[1],arguments[2]);return this},invoke:function(t){for(var e=0,i=this.items.length;i>e;e++)this.items[e][t].call(this.items[e],arguments[1],arguments[2]);return this},trigger:function(t,e){this.invoke("trigger",t,e)},destroy:function(){this.invoke("destroy")},detect:function(t){for(var e=0,i=this.items.length;i>e;e++)if(t.call(this.items[e],arguments[1],arguments[2]))return this.items[e];return!1},identify:function(t){for(var e=null,i=0,n=this.items.length;n>i;i++)if(e=t.call(this.items[i],arguments[1],arguments[2]))return e;return!1},_pObject:function(e){t._extend(this.p,e)},_pSingle:function(t,e){this.p[t]=e},set:function(t,e){return void 0===e?this.each(this._pObject,t):this.each(this._pSingle,t,e),this},at:function(t){return this.items[t]},first:function(){return this.items[0]},last:function(){return this.items[this.items.length-1]}}),t.select=function(e,i){return i=void 0===i?t.activeStage:i,i=t.stage(i),t._isNumber(e)?i.index[e]:new t.StageSelector(i,e)},t.stage=function(e){return e=void 0===e?t.activeStage:e,t.stages[e]},t.stageScene=function(e,i,n){t._isString(e)&&(e=t.scene(e)),t._isObject(i)&&(n=i,i=t._popProperty(n,"stage")||e&&e.opts.stage||0),n=t._clone(n);var s=t._popProperty(n,"stageClass")||e&&e.opts.stageClass||t.Stage;i=t._isUndefined(i)?e&&e.opts.stage||0:i,t.stages[i]&&t.stages[i].destroy(),t.activeStage=i;var o=t.stages[i]=new s(e,n);return o.options.asset&&o.loadAssets(o.options.asset),e&&o.loadScene(),t.activeStage=0,t.loop||t.gameLoop(t.stageGameLoop),o},t.stageGameLoop=function(e){var i,n,s;for(0>e&&(e=1/60),e>1/15&&(e=1/15),i=0,n=t.stages.length;n>i;i++)t.activeStage=i,s=t.stage(),s&&s.step(e);for(t.ctx&&t.clear(),i=0,n=t.stages.length;n>i;i++)t.activeStage=i,s=t.stage(),s&&s.render(t.ctx);t.activeStage=0,t.input&&t.ctx&&t.input.drawCanvas(t.ctx)},t.clearStage=function(e){t.stages[e]&&(t.stages[e].destroy(),t.stages[e]=null)},t.clearStages=function(){for(var e=0,i=t.stages.length;i>e;e++)t.stages[e]&&t.stages[e].destroy();t.stages.length=0}},Quintus.Sprites=function(t){return t.Class.extend("SpriteSheet",{init:function(e,i,n){if(!t.asset(i))throw"Invalid Asset:"+i;t._extend(this,{name:e,asset:i,w:t.asset(i).width,h:t.asset(i).height,tileW:64,tileH:64,sx:0,sy:0,spacingX:0,spacingY:0,frameProperties:{}}),n&&t._extend(this,n),this.tilew&&(this.tileW=this.tilew,delete this.tilew),this.tileh&&(this.tileH=this.tileh,delete this.tileh),this.cols=this.cols||Math.floor(this.w/(this.tileW+this.spacingX)),this.frames=this.cols*Math.floor(this.h/(this.tileH+this.spacingY))},fx:function(t){return Math.floor(t%this.cols*(this.tileW+this.spacingX)+this.sx)},fy:function(t){return Math.floor(Math.floor(t/this.cols)*(this.tileH+this.spacingY)+this.sy)},draw:function(e,i,n,s){e||(e=t.ctx),e.drawImage(t.asset(this.asset),this.fx(s),this.fy(s),this.tileW,this.tileH,Math.floor(i),Math.floor(n),this.tileW,this.tileH)}}),t.sheets={},t.sheet=function(e,i,n){return i?void(t.sheets[e]=new t.SpriteSheet(e,i,n)):t.sheets[e]},t.compileSheets=function(e,i){var n=t.asset(i);t._each(n,function(i,n){t.sheet(n,e,i)})},t.SPRITE_NONE=0,t.SPRITE_DEFAULT=1,t.SPRITE_PARTICLE=2,t.SPRITE_ACTIVE=4,t.SPRITE_FRIENDLY=8,t.SPRITE_ENEMY=16,t.SPRITE_POWERUP=32,t.SPRITE_UI=64,t.SPRITE_ALL=65535,t._generatePoints=function(t,e){if(!t.p.points||e){var i=t.p,n=i.w/2,s=i.h/2;i.points=[[-n,-s],[n,-s],[n,s],[-n,s]]}},t._generateCollisionPoints=function(e){if(e.matrix||e.refreshMatrix){e.c||(e.c={points:[]});var i=e.p,n=e.c;if(i.moved||n.origX!==i.x||n.origY!==i.y||n.origScale!==i.scale||n.origAngle!==i.angle){n.origX=i.x,n.origY=i.y,n.origScale=i.scale,n.origAngle=i.angle,e.refreshMatrix();var s;if(!(e.container||i.scale&&1!==i.scale||0!==i.angle)){for(s=0;s<e.p.points.length;s++)e.c.points[s]=e.c.points[s]||[],e.c.points[s][0]=i.x+e.p.points[s][0],e.c.points[s][1]=i.y+e.p.points[s][1];return n.x=i.x,n.y=i.y,n.cx=i.cx,n.cy=i.cy,n.w=i.w,void(n.h=i.h)}var o=e.container||t._nullContainer;n.x=o.matrix.transformX(i.x,i.y),n.y=o.matrix.transformY(i.x,i.y),n.angle=i.angle+o.c.angle,n.scale=(o.c.scale||1)*(i.scale||1);var r=1/0,a=1/0,h=-1/0,l=-1/0;for(s=0;s<e.p.points.length;s++){e.c.points[s]||(e.c.points[s]=[]),e.matrix.transformArr(e.p.points[s],e.c.points[s]);var c=e.c.points[s][0],u=e.c.points[s][1];r>c&&(r=c),c>h&&(h=c),a>u&&(a=u),u>l&&(l=u)}r===h&&(h+=1),a===l&&(l+=1),n.cx=n.x-r,n.cy=n.y-a,n.w=h-r,n.h=l-a}}},t.GameObject.extend("Sprite",{init:function(e,i){this.p=t._extend({x:0,y:0,z:0,opacity:1,angle:0,frame:0,type:t.SPRITE_DEFAULT|t.SPRITE_ACTIVE,name:"",spriteProperties:{}},i),this.matrix=new t.Matrix2D,this.children=[],t._extend(this.p,e),this.size(),this.p.id=this.p.id||t._uniqueId(),this.refreshMatrix()},size:function(t){!t&&this.p.w&&this.p.h||(this.asset()?(this.p.w=this.asset().width,this.p.h=this.asset().height):this.sheet()&&(this.p.w=this.sheet().tileW,this.p.h=this.sheet().tileH)),this.p.cx=t||void 0===this.p.cx?this.p.w/2:this.p.cx,this.p.cy=t||void 0===this.p.cy?this.p.h/2:this.p.cy},asset:function(e,i){return e?(this.p.asset=e,void(i&&(this.size(!0),t._generatePoints(this,!0)))):t.asset(this.p.asset)},sheet:function(e,i){return e?(this.p.sheet=e,void(i&&(this.size(!0),t._generatePoints(this,!0)))):t.sheet(this.p.sheet)},hide:function(){this.p.hidden=!0},show:function(){this.p.hidden=!1},set:function(e){return t._extend(this.p,e),this},_sortChild:function(t,e){return(t.p&&t.p.z||-1)-(e.p&&e.p.z||-1)},_flipArgs:{x:[-1,1],y:[1,-1],xy:[-1,-1]},render:function(e){var i=this.p;i.hidden||0==i.opacity||(e||(e=t.ctx),this.trigger("predraw",e),e.save(),void 0!==this.p.opacity&&1!==this.p.opacity&&(e.globalAlpha=this.p.opacity),this.matrix.setContextTransform(e),this.p.flip&&e.scale.apply(e,this._flipArgs[this.p.flip]),this.trigger("beforedraw",e),this.draw(e),this.trigger("draw",e),e.restore(),this.p.sort&&this.children.sort(this._sortChild),t._invoke(this.children,"render",e),this.trigger("postdraw",e),t.debug&&this.debugRender(e))},center:function(){this.container?(this.p.x=0,this.p.y=0):(this.p.x=t.width/2,this.p.y=t.height/2)},draw:function(e){var i=this.p;i.sheet?this.sheet().draw(e,-i.cx,-i.cy,i.frame):i.asset?e.drawImage(t.asset(i.asset),-i.cx,-i.cy):i.color&&(e.fillStyle=i.color,e.fillRect(-i.cx,-i.cy,i.w,i.h))},debugRender:function(e){this.p.points||t._generatePoints(this),e.save(),this.matrix.setContextTransform(e),e.beginPath(),e.fillStyle=this.p.hit?"blue":"red",e.strokeStyle="#FF0000",e.fillStyle="rgba(0,0,0,0.5)",e.moveTo(this.p.points[0][0],this.p.points[0][1]);for(var i=0;i<this.p.points.length;i++)e.lineTo(this.p.points[i][0],this.p.points[i][1]);if(e.lineTo(this.p.points[0][0],this.p.points[0][1]),e.stroke(),t.debugFill&&e.fill(),e.restore(),this.c){var n=this.c;e.save(),e.globalAlpha=1,e.lineWidth=2,e.strokeStyle="#FF00FF",e.beginPath(),e.moveTo(n.x-n.cx,n.y-n.cy),e.lineTo(n.x-n.cx+n.w,n.y-n.cy),e.lineTo(n.x-n.cx+n.w,n.y-n.cy+n.h),e.lineTo(n.x-n.cx,n.y-n.cy+n.h),e.lineTo(n.x-n.cx,n.y-n.cy),e.stroke(),e.restore()}},update:function(t){this.trigger("prestep",t),this.step&&this.step(t),this.trigger("step",t),this.refreshMatrix(),this.stage&&this.children.length>0&&this.stage.updateSprites(this.children,t,!0),this.p.collisions&&(this.p.collisions=[])},refreshMatrix:function(){var t=this.p;this.matrix.identity(),this.container&&this.matrix.multiply(this.container.matrix),this.matrix.translate(t.x,t.y),t.scale&&this.matrix.scale(t.scale,t.scale),this.matrix.rotateDeg(t.angle)}}),t.Sprite.extend("MovingSprite",{init:function(e,i){this._super(t._extend({vx:0,vy:0,ax:0,ay:0},e),i)},step:function(t){var e=this.p;e.vx+=e.ax*t,e.vy+=e.ay*t,e.x+=e.vx*t,e.y+=e.vy*t}}),t},Quintus.TMX=function(t){function e(t,e){var i=t.getAttribute(e);return isNaN(i)?i:+i}function i(t){for(var i=t.querySelectorAll("property"),n={},s=0;s<i.length;s++){var o=i[s];n[e(o,"name")]=e(o,"value")}return n}t.assetTypes.tmx="TMX",t.loadAssetTMX=function(e,i,n,s){t.loadAssetOther(e,i,function(t,e){var i=new DOMParser,s=i.parseFromString(e,"application/xml");n(t,s)},s)},t._tmxExtractAssetName=function(t){var e=t.getAttribute("source"),i=e.split("/");return i[i.length-1]},t._tmxExtractSources=function(e){var i=e.querySelectorAll("[source]");return t._map(i,t._tmxExtractAssetName)},t.loadTMX=function(e,i,n){t._isString(e)&&(e=t._normalizeArg(e));var s=[];t._each(e,function(e){"tmx"===t._fileExtension(e)&&s.push(e)});var o=[];t.load(e,function(){t._each(s,function(e){var i=t._tmxExtractSources(t.asset(e));o=o.concat(i)}),o.length>0?t.load(o,i,n):i()})},t._tmxLoadTilesets=function(n,s){function o(t){var e=t.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}for(var r=[],a=0;a<n.length;a++){for(var h=n[a],l=e(h,"name"),c=e(h,"firstgid"),u=t._tmxExtractAssetName(h.querySelector("image")),d={},p={tileW:e(h,"tilewidth"),tileH:e(h,"tileheight"),spacingX:e(h,"spacing"),spacingY:e(h,"spacing")},f=h.querySelectorAll("tile"),g=0;g<f.length;g++){var m=f[g],v=e(m,"id"),y=c+v,x=i(m);x.points&&(x.points=t._map(x.points.split(" "),o)),s[y]=x,d[v]=x}p.frameProperties=d,r.push([c,l]),t.sheet(l,u,p)}return r},t._tmxProcessImageLayer=function(e,n,s,o){var r=t._tmxExtractAssetName(o.querySelector("image")),a=i(o);a.asset=r,e.insert(new t.Repeater(a))},t._lookupGid=function(t,e){for(var i=0;e[i+1]&&t>=e[i+1][0];)i++;return e[i]},t._tmxProcessTileLayer=function(n,s,o,r){for(var a,h,l,c=r.querySelectorAll("tile"),u=e(r,"width"),d=e(r,"height"),p=[],f=0,g=0;d>g;g++){p[g]=[];for(var m=0;u>m;m++){var v=e(c[f],"gid");0===v?p[g].push(null):(h||(a=t._lookupGid(e(c[f],"gid"),s),h=a[0],l=a[1]),p[g].push(v-h)),f++}}var y=t._extend({tileW:t.sheet(l).tileW,tileH:t.sheet(l).tileH,sheet:l,tiles:p},i(r)),x=y.Class||"TileLayer";y.collision?n.collisionLayer(new t[x](y)):n.insert(new t[x](y))},t._tmxProcessObjectLayer=function(n,s,o,r){for(var a=r.querySelectorAll("object"),h=0;h<a.length;h++){var l=a[h],c=e(l,"gid"),u=e(l,"x"),d=e(l,"y"),p=o[c],f=i(l);if(!p)throw"Invalid TMX Object: missing properties for GID:"+c;if(!p.Class)throw"Invalid TMX Object: missing Class for GID:"+c;var g=p.Class;if(!g)throw"Invalid TMX Object Class: "+g+" GID:"+c;var m=t._extend(t._extend({x:u,y:d},p),f),v=new t[g](m);v.p.x+=v.p.w/2,v.p.y-=v.p.h/2,n.insert(v)}},t._tmxProcessors={objectgroup:t._tmxProcessObjectLayer,layer:t._tmxProcessTileLayer,imagelayer:t._tmxProcessImageLayer},t.stageTMX=function(e,i){var n=t._isString(e)?t.asset(e):e,s={},o=n.getElementsByTagName("tileset"),r=t._tmxLoadTilesets(o,s);t._each(n.documentElement.childNodes,function(e){var n=e.tagName;t._tmxProcessors[n]&&t._tmxProcessors[n](i,r,s,e)})}},Quintus.Touch=function(t){if(t._isUndefined(Quintus.Sprites))throw"Quintus.Touch requires Quintus.Sprites Module";var e=(!!("ontouchstart"in window),[0]),i=0;t.Evented.extend("TouchSystem",{init:function(){var e=this;this.boundTouch=function(t){e.touch(t)},this.boundDrag=function(t){e.drag(t)},this.boundEnd=function(t){e.touchEnd(t)},t.el.addEventListener("touchstart",this.boundTouch),t.el.addEventListener("mousedown",this.boundTouch),t.el.addEventListener("touchmove",this.boundDrag),t.el.addEventListener("mousemove",this.boundDrag),t.el.addEventListener("touchend",this.boundEnd),t.el.addEventListener("mouseup",this.boundEnd),t.el.addEventListener("touchcancel",this.boundEnd),this.touchPos=new t.Evented,this.touchPos.grid={},this.touchPos.p={w:1,h:1,cx:0,cy:0},this.activeTouches={},this.touchedObjects={}},destroy:function(){t.el.removeEventListener("touchstart",this.boundTouch),t.el.removeEventListener("mousedown",this.boundTouch),t.el.removeEventListener("touchmove",this.boundDrag),t.el.removeEventListener("mousemove",this.boundDrag),t.el.removeEventListener("touchend",this.boundEnd),t.el.removeEventListener("mouseup",this.boundEnd),t.el.removeEventListener("touchcancel",this.boundEnd)},normalizeTouch:function(e,i){var n=t.el,s=n.getBoundingClientRect(),o=window.getComputedStyle(n),r=e.clientX-s.left-parseInt(o.paddingLeft),a=e.clientY-s.top-parseInt(o.paddingTop);if((t._isUndefined(r)||t._isUndefined(a))&&(r=e.offsetX,a=e.offsetY),(t._isUndefined(r)||t._isUndefined(a))&&(r=e.layerX,a=e.layerY),t._isUndefined(r)||t._isUndefined(a)){if(void 0===t.touch.offsetX){t.touch.offsetX=0,t.touch.offsetY=0;var n=t.el;do t.touch.offsetX+=n.offsetLeft,t.touch.offsetY+=n.offsetTop;while(n=n.offsetParent)}r=e.pageX-t.touch.offsetX,a=e.pageY-t.touch.offsetY}return this.touchPos.p.ox=this.touchPos.p.px=r/t.cssWidth*t.width,this.touchPos.p.oy=this.touchPos.p.py=a/t.cssHeight*t.height,i.viewport&&(this.touchPos.p.px/=i.viewport.scale,this.touchPos.p.py/=i.viewport.scale,this.touchPos.p.px+=i.viewport.x,this.touchPos.p.py+=i.viewport.y),this.touchPos.p.x=this.touchPos.p.px,this.touchPos.p.y=this.touchPos.p.py,this.touchPos.obj=null,this.touchPos},touch:function(n){for(var s=n.changedTouches||[n],o=0;o<s.length;o++)for(var r=0;r<e.length;r++){var a=s[o],h=t.stage(e[r]);if(h){a.identifier=a.identifier||0;var l=this.normalizeTouch(a,h);h.regrid(l,!0);var c,u=h.search(l,i);if((u||r===e.length-1)&&(c=u&&u.obj,l.obj=c,this.trigger("touch",l)),c&&!this.touchedObjects[c]){this.activeTouches[a.identifier]={x:l.p.px,y:l.p.py,origX:c.p.x,origY:c.p.y,sx:l.p.ox,sy:l.p.oy,identifier:a.identifier,obj:c,stage:h},this.touchedObjects[c.p.id]=!0,c.trigger("touch",this.activeTouches[a.identifier]);break}}}},drag:function(t){for(var e=t.changedTouches||[t],i=0;i<e.length;i++){var n=e[i];n.identifier=n.identifier||0;var s=this.activeTouches[n.identifier],o=s&&s.stage;if(s){var r=this.normalizeTouch(n,o);s.x=r.p.px,s.y=r.p.py,s.dx=r.p.ox-s.sx,s.dy=r.p.oy-s.sy,s.obj.trigger("drag",s)}}t.preventDefault()},touchEnd:function(t){for(var e=t.changedTouches||[t],i=0;i<e.length;i++){var n=e[i];n.identifier=n.identifier||0;var s=this.activeTouches[n.identifier];s&&(s.obj.trigger("touchEnd",s),delete this.touchedObjects[s.obj.p.id],this.activeTouches[n.identifier]=null)}t.preventDefault()}}),t.touch=function(n,s){return t.untouch(),i=n||t.SPRITE_UI,e=s||[2,1,0],t._isArray(e)||(e=[e]),t._touch||(t.touchInput=new t.TouchSystem),t},t.untouch=function(){return t.touchInput&&(t.touchInput.destroy(),delete t.touchInput),t}},Quintus.UI=function(t){if(t._isUndefined(Quintus.Touch))throw"Quintus.UI requires Quintus.Touch Module";t.UI={},t.UI.roundRect=function(t,e){t.beginPath(),t.moveTo(-e.cx+e.radius,-e.cy),t.lineTo(-e.cx+e.w-e.radius,-e.cy),t.quadraticCurveTo(-e.cx+e.w,-e.cy,-e.cx+e.w,-e.cy+e.radius),t.lineTo(-e.cx+e.w,-e.cy+e.h-e.radius),t.quadraticCurveTo(-e.cx+e.w,-e.cy+e.h,-e.cx+e.w-e.radius,-e.cy+e.h),t.lineTo(-e.cx+e.radius,-e.cy+e.h),t.quadraticCurveTo(-e.cx,-e.cy+e.h,-e.cx,-e.cy+e.h-e.radius),t.lineTo(-e.cx,-e.cy+e.radius),t.quadraticCurveTo(-e.cx,-e.cy,-e.cx+e.radius,-e.cy),t.closePath()},t.UI.Container=t.Sprite.extend("UI.Container",{init:function(e,i){var n,s=t._clone(e||{});e&&t._isString(e.w)&&(n=e.w.match(/^[0-9]+%$/))&&(s.w=parseInt(e.w,10)*t.width/100,s.x=t.width/2-s.w/2),e&&t._isString(e.h)&&(n=e.h.match(/^[0-9]+%$/))&&(s.h=parseInt(e.h,10)*t.height/100,s.y=t.height/2-s.h/2),this._super(t._defaults(s,i),{opacity:1,hidden:!1,fill:null,highlight:null,radius:5,stroke:"#000",border:!1,shadow:!1,shadowColor:!1,outlineWidth:!1,outlineColor:"#000",type:t.SPRITE_NONE})},insert:function(t){return this.stage.insert(t,this),t},fit:function(t,e){if(0!==this.children.length){void 0===t&&(t=0),void 0===e&&(e=t);for(var i=1/0,n=1/0,s=-1/0,o=-1/0,r=0;r<this.children.length;r++){var a=this.children[r],h=a.p.x-a.p.cx,l=a.p.y-a.p.cy,c=a.p.x-a.p.cx+a.p.w,u=a.p.y-a.p.cy+a.p.h;i>h&&(i=h),n>l&&(n=l),c>s&&(s=c),u>o&&(o=u)}this.p.cx=-i+e,this.p.cy=-n+t,this.p.w=s-i+2*e,this.p.h=o-n+2*t}},addShadow:function(e){if(this.p.shadow){var i=t._isNumber(this.p.shadow)?this.p.shadow:5;e.shadowOffsetX=i,e.shadowOffsetY=i,e.shadowColor=this.p.shadowColor||"rgba(0,0,50,0.1)"}},clearShadow:function(t){t.shadowColor="transparent"},drawRadius:function(e){t.UI.roundRect(e,this.p),this.addShadow(e),e.fill(),this.p.border&&(this.clearShadow(e),e.lineWidth=this.p.border,e.stroke())},drawSquare:function(t){this.addShadow(t),this.p.fill&&t.fillRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h),this.p.border&&(this.clearShadow(t),t.lineWidth=this.p.border,t.strokeRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h))},draw:function(t){return this.p.hidden?!1:void((this.p.border||this.p.fill)&&(t.globalAlpha=this.p.opacity,t.fillStyle=1===this.p.frame&&this.p.highlight?this.p.highlight:this.p.fill,t.strokeStyle=this.p.stroke,this.p.radius>0?this.drawRadius(t):this.drawSquare(t)))}}),t.UI.Text=t.Sprite.extend("UI.Text",{init:function(e,i){this._super(t._defaults(e||{},i),{type:t.SPRITE_UI,size:24,lineHeight:1.2,align:"center"}),this.p.label&&this.calcSize()},calcSize:function(){var e=this.p;this.setFont(t.ctx),this.splitLabel=e.label.split("\n");e.w=0;for(var i=0;i<this.splitLabel.length;i++){var n=t.ctx.measureText(this.splitLabel[i]);n.width>e.w&&(e.w=n.width)}e.lineHeightPx=e.size*e.lineHeight,e.h=e.lineHeightPx*this.splitLabel.length,e.halfLeading=.5*e.size*Math.max(0,e.lineHeight-1),e.cy=0,"center"==e.align?(e.cx=e.w/2,e.points=[[-e.cx,0],[e.cx,0],[e.cx,e.h],[-e.cx,e.h]]):"right"===e.align?(e.cx=e.w,e.points=[[-e.w,0],[0,0],[0,e.h],[-e.w,e.h]]):(e.cx=0,e.points=[[0,0],[e.w,0],[e.w,e.h],[0,e.h]])},prerender:function(){this.p.oldLabel!==this.p.label&&(this.p.oldLabel=this.p.label,this.calcSize(),this.el.width=this.p.w,this.el.height=4*this.p.h,this.ctx.clearRect(0,0,this.p.w,this.p.h),this.ctx.fillStyle="#FF0",this.ctx.fillRect(0,0,this.p.w,this.p.h/2),this.setFont(this.ctx),this.ctx.fillText(this.p.label,0,0))
},draw:function(t){var e=this.p;if(0!==e.opacity){e.oldLabel!==e.label&&this.calcSize(),this.setFont(t),void 0!==e.opacity&&(t.globalAlpha=e.opacity);for(var i=0;i<this.splitLabel.length;i++)e.outlineWidth&&t.strokeText(this.splitLabel[i],0,e.halfLeading+i*e.lineHeightPx),t.fillText(this.splitLabel[i],0,e.halfLeading+i*e.lineHeightPx)}},asset:function(){return this.el},setFont:function(t){t.textBaseline="top",t.font=this.font(),t.fillStyle=this.p.color||"black",t.textAlign=this.p.align||"left",t.strokeStyle=this.p.outlineColor||"black",t.lineWidth=this.p.outlineWidth||0},font:function(){return this.fontString?this.fontString:(this.fontString=(this.p.weight||"800")+" "+(this.p.size||24)+"px "+(this.p.family||"Arial"),this.fontString)}}),t.UI.Button=t.UI.Container.extend("UI.Button",{init:function(e,i,n){if(this._super(t._defaults(e||{},n),{type:t.SPRITE_UI|t.SPRITE_DEFAULT,keyActionName:null}),this.p.label&&(!this.p.w||!this.p.h)){t.ctx.save(),this.setFont(t.ctx);var s=t.ctx.measureText(this.p.label);t.ctx.restore(),this.p.h||(this.p.h=44),this.p.w||(this.p.w=s.width+20)}isNaN(this.p.cx)&&(this.p.cx=this.p.w/2),isNaN(this.p.cy)&&(this.p.cy=this.p.h/2),this.callback=i,this.on("touch",this,"highlight"),this.on("touchEnd",this,"push"),this.p.keyActionName&&t.input.on(this.p.keyActionName,this,"push")},highlight:function(){"undefined"!=typeof this.sheet()&&this.sheet().frames>1&&(this.p.frame=1)},push:function(){this.p.frame=0,this.callback&&this.callback(),this.trigger("click")},draw:function(e){this._super(e),(this.p.asset||this.p.sheet)&&t.Sprite.prototype.draw.call(this,e),this.p.label&&(e.save(),this.setFont(e),e.fillText(this.p.label,0,0),e.restore())},setFont:function(t){t.textBaseline="middle",t.font=this.p.font||"400 24px arial",t.fillStyle=this.p.fontColor||"black",t.textAlign="center"}}),t.UI.IFrame=t.Sprite.extend("UI.IFrame",{init:function(e){this._super(e,{opacity:1,type:t.SPRITE_UI|t.SPRITE_DEFAULT}),t.wrapper.style.overflow="hidden",this.iframe=document.createElement("IFRAME"),this.iframe.setAttribute("src",this.p.url),this.iframe.style.position="absolute",this.iframe.style.zIndex=500,this.iframe.setAttribute("width",this.p.w),this.iframe.setAttribute("height",this.p.h),this.iframe.setAttribute("frameborder",0),this.p.background&&(this.iframe.style.backgroundColor=this.p.background),t.wrapper.appendChild(this.iframe),this.on("inserted",function(t){this.positionIFrame(),t.on("destroyed",this,"remove")})},positionIFrame:function(){var t=this.p.x,e=this.p.y;this.stage.viewport&&(t-=this.stage.viewport.x,e-=this.stage.viewport.y),(this.oldX!==t||this.oldY!==e||this.oldOpacity!==this.p.opacity)&&(this.iframe.style.top=e-this.p.cy+"px",this.iframe.style.left=t-this.p.cx+"px",this.iframe.style.opacity=this.p.opacity,this.oldX=t,this.oldY=e,this.oldOpacity=this.p.opacity)},step:function(t){this._super(t),this.positionIFrame()},remove:function(){this.iframe&&(t.wrapper.removeChild(this.iframe),this.iframe=null)}}),t.UI.HTMLElement=t.Sprite.extend("UI.HTMLElement",{init:function(e){this._super(e,{opacity:1,type:t.SPRITE_UI}),t.wrapper.style.overflow="hidden",this.el=document.createElement("div"),this.el.innerHTML=this.p.html,t.wrapper.appendChild(this.el),this.on("inserted",function(t){this.position(),t.on("destroyed",this,"remove"),t.on("clear",this,"remove")})},position:function(){},step:function(t){this._super(t),this.position()},remove:function(){this.el&&(t.wrapper.removeChild(this.el),this.el=null)}}),t.UI.VerticalLayout=t.Sprite.extend("UI.VerticalLayout",{init:function(t){this.children=[],this._super(t,{type:0})},insert:function(t){return this.stage.insert(t,this),this.relayout(),t},relayout:function(){for(var t=0,e=0;e<this.children.length;e++)t+=this.children[e].p.h||0;this.p.h-t}})};