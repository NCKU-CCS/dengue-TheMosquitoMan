!function(t){function e(t,e,i){h.html(e),svg=d3.select("#bar").append("svg").attr("width","100%").attr("height",p+g.top+g.bottom).append("g").attr("transform","translate("+g.left+","+g.top+")").call(h),t.forEach(function(t){"string"==typeof t.date&&(t.date=m(t.date)),t.value=+t.value}),c=d3.extent(t,function(t){return t.date}),o=d3.time.scale().domain(c).range([0,v]),l=d3.scale.linear().range([p,0]),s=d3.svg.axis().scale(o).orient("bottom").ticks(30).tickFormat(d3.time.format("%m/%d")),u=d3.svg.axis().scale(l).orient("left").ticks(10),l.domain([0,d3.max(t,function(t){return t.value})]),n(),r(t),i&&(a(t,5,"五日移動平均線","#E10707",-10,v-100),a(t,10,"十日移動平均線","#15B321",-10,v-220))}function a(t,e,a,r,n,d){var s=i(e),u=s(t),c=d3.svg.line().interpolate("basis").x(function(t){return o(t.date)}).y(function(t){return l(t.value)});svg.append("path").datum(u).attr("class","line").attr("stroke",r).attr("d",c),svg.append("text").attr("transform","translate("+d+","+n+")").attr("dy",".35em").attr("text-anchor","start").style("fill",r).text(a)}function r(t){barWidth=v/d(c[0],c[1]),barWidth<0&&(barWidth=1),svg.selectAll("bar").data(t).enter().append("rect").style("fill",function(t){return t["降水量"]>0?"orange":"steelblue"}).attr("class",function(t){return t.drug_times>0?"in-drug-day":""}).attr("x",function(t){return o(t.date)}).attr("width",barWidth).attr("y",function(t){return l(t.value)}).attr("height",function(t){return p-l(t.value)}).attr("id",function(t){var e=new Date(t.date.getTime()+864e5),a="bar-"+e.toISOString().substring(0,10).replace(/-/g,"-");return a}).on("mouseover",h.show).on("mouseout",h.hide)}function n(){svg.append("g").attr("class","x axis").attr("transform","translate(0,"+p+")").call(s).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy","-.55em").attr("transform","rotate(-65)"),svg.append("g").attr("class","y axis").call(u).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("當日病例數（人）")}function i(t){return function(e){return e=e.map(function(a,r,n){var i,o,l,s=r+t-1;return s<e.length?(i=n.slice(r,s+1),l=i[i.length-1],o=i.reduce(function(e,a){return d(e.date,a.date)<t?{value:e.value+a.value,date:l.date}:{value:e.value,date:l.date}}),{value:o.value/t,date:l.date}):void 0}),e=e.filter(function(t){return"undefined"!=typeof t})}}function d(t,e){var a=Math.abs(t.getTime()-e.getTime()),r=Math.ceil(a/864e5);return r}t.drawChart=e;var o,l,s,u,c,f=$("#bar").width(),m=d3.time.format("%Y/%m/%d").parse,g={top:20,right:20,bottom:70,left:40},v=f-g.left-g.right,p=200,h=d3.tip().attr("class","d3-tip").offset([-10,0])}(window);