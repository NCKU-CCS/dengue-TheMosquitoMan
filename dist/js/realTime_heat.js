function getdata(e){var t=null;return $.ajax({async:!1,url:e,type:"GET",success:function(e){t=e}}),t}function heatMap(e){switch(e){case"3":var t=dataThree,a=InOutThree;break;case"5":var t=dataFive,a=InOutFive;break;case"7":var t=dataSeven,a=InOutFive;break;case"all":var t=dataAll,a=InOutAll}var n=[0,0],r=30;if(t.length>0){if(null==mymap){$(".no_content").remove(),$(".mapM").append('<div id="mapid"></div>'),mymap=L.map("mapid").setView([22.9971,120.2126],15),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw",{maxZoom:18,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',id:"mapbox.streets"}).addTo(mymap),btn.addTo(mymap),legend.addTo(mymap);{L.control.locate({strings:{title:"Show me where I am, yo!"}}).addTo(mymap)}$(".description").prepend('<h2 class="DayTitle" id="header"></h2>'),document.getElementById("header").innerHTML=trans[nowValue]+"環境回報分布圖",$(".compare").append('<p id="first"></p>                                      <p id="second"></p>')}mymap.removeLayer(heats),heats=new L.LayerGroup,t=arrayUnique(t);var o=[],i=[];t.forEach(function(e){e[2]=e[2]/r,o.push(e[0]),i.push(e[1])}),0!=filterOutliers(o).length&&(o=filterOutliers(o),i=filterOutliers(i)),n=[sum(o)/o.length,sum(i)/i.length],mymap.setView(n,16);{L.heatLayer(t,{radius:25,blur:17,minOpacity:.4,gradient:{.4:"SlateBlue",.6:"Gold",1:"red"}}).addTo(heats)}if(mymap.addLayer(heats),$("#mapid").scrollView(),null===svg){var l={top:10,right:10,bottom:10,left:10},u=350-l.left-l.right,s=250-l.top-l.bottom;svg=d3.select(".svgPlot").append("svg").attr("width",u+l.left+l.right).attr("height",s+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")");var d=d3.scale.category20b().range(["#74c476","#c6dbef"]),c=(svg.datum(data2).selectAll(".pie").data(pie).enter().append("path").attr("class","pie").attr("transform","translate(120,120)").style("opacity",.95).attr("fill",function(e,t){return d(t)}).attr("d",arc).each(function(e){this._current=e}),[]),p=svg.selectAll(".leg").data(d.domain().slice().reverse()).enter().append("g").attr("class",function(e){return c.push(e),"leg"}).attr("transform",function(e,t){return"translate(0,"+20*t+")"});c=c.reverse(),p.append("rect").attr("x",270).attr("y",2).attr("width",18).attr("height",18).style("fill",d),p.append("text").attr("x",290).attr("y",9).attr("dy",".35em").style("font-size","14px").style("font-weight","normal").text(function(e){switch(e){case 0:return"室外";case 1:return"室內"}})}else 0!=v&&piePlot(a);data2[0].value<data2[1].value?(document.getElementById("first").innerHTML="目前室內回報數 > 室外回報數",document.getElementById("second").innerHTML="請多注意室內周遭積水髒亂處"):data2[0].value==data2[1].value?(document.getElementById("first").innerHTML="目前室外回報數 = 室內回報數",document.getElementById("second").innerHTML="請多注意室內、外周遭積水髒亂處"):(document.getElementById("first").innerHTML="目前室外回報數 > 室內回報數",document.getElementById("second").innerHTML="請多注意室外周遭積水髒亂處")}else console.log("none of any event"),removeMap(),$(".title").append('<div class="no_content">                                    <img src="image/no_content.png">                                     <h4>此區間暫無調查資料</h4>                                </div>')}function arrayUnique(e){for(var t=e.concat(),a=0;a<t.length;++a)for(var n=a+1;n<t.length;++n)t[a][0]===t[n][0]&&t[a][1]===t[n][1]&&(t[a][2]++,t.splice(n--,1));return t}function filterOutliers(e){var t=e.concat();t.sort(function(e,t){return e-t});var a=t[Math.floor(t.length/4)],n=t[Math.ceil(.75*t.length)],r=n-a,o=n+1.5*r,i=a-1.5*r,l=t.filter(function(e){return o>e&&e>i});return l}function sum(e){var t=e.reduce(function(e,t){return e+t},0);return t}function removeMap(){$(".no_content").remove(),$("#mapid").remove(),null!=mymap&&(mymap.remove(),mymap=null,console.log("move")),$("#first").remove(),$("#second").remove(),$("svg").remove(),svg=null,$(".DayTitle").remove()}function judgeDate(e,t){var a=new Date,n=a.getFullYear()+"/"+(a.getMonth()+1)+"/"+a.getDate(),r=new Date(n);"0"===e[1].substr(0,1)&&(e[1]=e[1].substr(1,2)),"0"===e[2].substr(0,1)&&(e[2]=e[2].substr(1,2));var o=new Date(e[1]+"/"+e[2]+"/"+e[0]);return"all"===t?"1":r.getTime()-o.getTime()>24*(parseInt(t)-1)*60*60*1e3?"0":"1"}function piePlot(e){console.log("update");var t=svg.datum(e).selectAll(".pie");pie.value(function(e){return e.value}),t=t.data(pie),t.transition().duration(300).attrTween("d",arcTween)}function arcTween(e){var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){return arc(t(e))}}var data_url="https://dengue-breeding-source.s3.amazonaws.com:443/breeding-sources/heatmap_blurred.json",dataThree=[],dataFive=[],dataSeven=[],dataAll=[],InOutThree=[],InOutFive=[],InOutSeven=[],InOutAll=[],datas=getdata(data_url),data2=[{value:20},{value:30}],svg=null,radius=120,pie=d3.layout.pie().sort(null).value(function(e){return e.value}),arc=d3.svg.arc().outerRadius(radius-10).innerRadius(0);console.log(getdata(data_url)),$.fn.scrollView=function(){return console.log("ScollFn"),this.each(function(){$("html,body").animate({scrollTop:$(this).offset().top-.025*screen.height},"fast")})};var mon={Jan:"1",Feb:"2",Mar:"3",Apr:"4",May:"5",Jun:"6",Jul:"7",Aug:"8",Sep:"9",Oct:"10",Nov:"11",Dec:"12"},in3=0,out3=0,in7=0,out7=0,out5=0,in5=0,inA=0,outA=0;datas.data.forEach(function(e){var t=(e.update_time.substr(e.update_time.indexOf(" "),e.update_time.indexOf(" ")+2),e.update_time.split(" ")),a=t.indexOf("");-1!=a&&t.splice(a,1);var n=[t[2],t[4],mon[t[1]]];if("1"===judgeDate(n,"all")){var r=[e.lat,e.lng,1];if("戶外"===e.type?outA+=1:inA+=1,dataAll.push(r),"1"===judgeDate(n,"7")){var r=[e.lat,e.lng,1];if("戶外"===e.type?out7+=1:in7+=1,dataSeven.push(r),"1"===judgeDate(n,"5")){var r=[e.lat,e.lng,1];if("戶外"===e.type?out5+=1:in5+=1,dataFive.push(r),"1"===judgeDate(n,"3")){var r=[e.lat,e.lng,1];"戶外"===e.type?out3+=1:in3+=1,dataThree.push(r)}}}}}),InOutThree=[{value:out3},{value:in3}],InOutFive=[{value:out5},{value:in5}],InOutSeven=[{value:out7},{value:in7}],InOutAll=[{value:outA},{value:inA}];var v=0,nowValue="all",trans={3:"最近三天間",5:"最近五天間",7:"最近七天間",all:"至今所有"};$(".ui.dropdown").dropdown(),$(".dropdown").dropdown({onChange:function(e,t){console.log(t),""===e||($(".description").css("float","left"),$(".description").css("margin","40px 5% 20px 5%"),v+=1,nowValue=e,heatMap(e),document.getElementById("header").innerHTML=trans[nowValue]+"環境回報分布圖")}});var heats=new L.LayerGroup,mymap,legend=L.control({position:"bottomright"});legend.onAdd=function(){var e=L.DomUtil.create("div","info legend");return e.innerHTML+='<span class = "legend-header">區域內舉報數（個）</span><HR>',e.innerHTML+='<i style="background:linear-gradient(to bottom, rgba(106,90,205,0.7) 0%,rgba(255,215,0,0.4) 50%,rgba(255,0,0,1) 100%);"></i>',e.innerHTML+="0<br>&#8768;<br>30 +",e};var btn=L.control({position:"bottomright"});btn.onAdd=function(){var e=L.DomUtil.create("div","ui button quit");return e.innerHTML+='<span class = "title">改變調查區間</span>',e},$(document).on("click",".ui.button.quit",function(){$(".ui.dropdown").dropdown("restore defaults"),$(".description").css("float","none"),$(".description").css("margin","auto"),removeMap()}),heatMap("all");